<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="EMA Oracle Pallet"><meta name="keywords" content="rust, rustlang, rust-lang, pallet_ema_oracle"><title>pallet_ema_oracle - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-1f7d512b176f0f72.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-124a1ca42af929b6.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-e963ab4a0d0c903e.css" id="mainThemeStyle"><link rel="stylesheet" id="themeStyle" href="../static.files/light-046227e470cd3629.css"><link rel="stylesheet" disabled href="../static.files/dark-800f2ee593c8e6f7.css"><link rel="stylesheet" disabled href="../static.files/ayu-9edae3c387f5a5b3.css"><script id="default-settings" ></script><script src="../static.files/storage-d43fa987303ecbbb.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-287cecec4dbb45b0.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../pallet_ema_oracle/index.html"><div class="logo-container"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><h2></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../pallet_ema_oracle/index.html"><div class="logo-container"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><h2 class="location"><a href="#">Crate pallet_ema_oracle</a></h2><div class="sidebar-elems"><ul class="block"><li class="version">Version 1.0.3</li><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#functions">Functions</a></li><li><a href="#types">Type Definitions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-5ec35bf9ca753509.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn">Crate <a class="mod" href="#">pallet_ema_oracle</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../src/pallet_ema_oracle/lib.rs.html#18-573">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="ema-oracle-pallet"><a href="#ema-oracle-pallet">EMA Oracle Pallet</a></h2><h3 id="overview"><a href="#overview">Overview</a></h3>
<p>This pallet provides exponential moving average (EMA) oracles of different periods for price,
volume and liquidity for a combination of source and asset pair based on data coming in from
different sources.</p>
<h4 id="integration"><a href="#integration">Integration</a></h4>
<p>Data is ingested by plugging the provided <code>OnActivityHandler</code> into callbacks provided by other
pallets (e.g. xyk pallet).</p>
<p>It is meant to be used by other pallets via the <code>AggregatedOracle</code> and <code>AggregatedPriceOracle</code>
traits.</p>
<p>When integrating with this pallet take care to use the <code>on_trade_weight</code>,
<code>on_liquidity_changed_weight</code> and <code>get_entry_weight</code> into account when calculating the weight
for your extrinsics (that either feed data into or take data from this pallet).</p>
<h4 id="concepts"><a href="#concepts">Concepts</a></h4>
<ul>
<li><em>EMA</em>: Averaging via exponential decay with a smoothing factor; meaning each new value to
integrate into the average is multiplied with a smoothing factor between 0 and 1.</li>
<li><em>Smoothing Factor</em>: A factor applied to each value aggregated into the averaging oracle.
Implicitly determines the oracle period.</li>
<li><em>Period</em>: The window over which an oracle is averaged. Certain smoothing factors correspond to
an oracle period. E.g. ten minutes oracle period ≈ 0.0198</li>
<li><em>Source</em>: The source of the data. E.g. xyk pallet.</li>
</ul>
<h4 id="implementation"><a href="#implementation">Implementation</a></h4>
<p>This pallet aggregates data in the following way: <code>on_trade</code> or <code>on_liquidity_changed</code> a new
entry is created for the incoming data. This then updates any existing entries already present
in storage for this block (for this combination of source and assets) or inserts it. Note that
this aggregation is NOT based on EMA, yet, it just sums the volume and replaces price and
liquidity with the most recent value.</p>
<p>At the end of the block, all the entries are merged into permanent storage via the exponential
moving average logic defined in the math package this pallet depens on. There is one oracle
entry for each combination of <code>(source, asset_pair, period)</code> in storage.</p>
<p>Oracle values are accessed lazily. This means that the storage does not contain the most recent
value, but the value calculated the last time it was updated via trade or liquidity change. On a
read the values are read from storage and then fast-forwarded (assuming the volume to be zero
and the price and liquidity to be constant) to the last block. Note: The most recent oracle
values are always from the last block. This avoids e.g. sandwiching risks. If you want current
prices you should use a spot price or similar.</p>
</div></details><h2 id="reexports" class="small-section-header"><a href="#reexports">Re-exports</a></h2><div class="item-table"><div class="item-row"><div class="item-left import-item"><code>pub use <a class="mod" href="pallet/index.html" title="mod pallet_ema_oracle::pallet">pallet</a>::*;</code></div></div></div><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="mod" href="pallet/index.html" title="pallet_ema_oracle::pallet mod">pallet</a></div><div class="item-right docblock-short">The module that hosts all the
<a href="https://docs.substrate.io/main-docs/build/events-errors/">FRAME</a>
types needed to add this pallet to a
runtime.</div></div><div class="item-row"><div class="item-left module-item"><a class="mod" href="weights/index.html" title="pallet_ema_oracle::weights mod">weights</a></div><div class="item-right docblock-short">Autogenerated weights for pallet_ema_oracle</div></div></div><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.OnActivityHandler.html" title="pallet_ema_oracle::OnActivityHandler struct">OnActivityHandler</a></div><div class="item-right docblock-short">A callback handler for trading and liquidity activity that schedules oracle updates.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.OracleEntry.html" title="pallet_ema_oracle::OracleEntry struct">OracleEntry</a></div><div class="item-right docblock-short">A type representing data produced by a trade or liquidity event. Timestamped to the block where
it was created.</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.OracleError.html" title="pallet_ema_oracle::OracleError enum">OracleError</a></div><div class="item-right docblock-short">Possible errors when requesting an oracle value.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.OraclePeriod.html" title="pallet_ema_oracle::OraclePeriod enum">OraclePeriod</a></div><div class="item-right docblock-short">Defines the different kinds of aggregation periods for oracles.</div></div></div><h2 id="constants" class="small-section-header"><a href="#constants">Constants</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.MAX_PERIODS.html" title="pallet_ema_oracle::MAX_PERIODS constant">MAX_PERIODS</a></div><div class="item-right docblock-short">The maximum number of periods that could have corresponding oracles.</div></div><div class="item-row"><div class="item-left module-item"><a class="constant" href="constant.MAX_UNIQUE_ENTRIES.html" title="pallet_ema_oracle::MAX_UNIQUE_ENTRIES constant">MAX_UNIQUE_ENTRIES</a></div><div class="item-right docblock-short">Maximum number of unique oracle entries expected in one block. Empirically determined by running
<code>trades_estimation.py</code> and rounding up from 212 to 300. Not necessarily representative for all
chains, configure <code>MaxUniqueEntries</code> according to your chain.</div></div></div><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.determine_normalized_liquidity.html" title="pallet_ema_oracle::determine_normalized_liquidity fn">determine_normalized_liquidity</a></div><div class="item-right docblock-short">Construct <code>Liquidity</code> based on unordered assets.</div></div><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.determine_normalized_price.html" title="pallet_ema_oracle::determine_normalized_price fn">determine_normalized_price</a></div><div class="item-right docblock-short">Calculate price from ordered assets</div></div><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.determine_normalized_volume.html" title="pallet_ema_oracle::determine_normalized_volume fn">determine_normalized_volume</a></div><div class="item-right docblock-short">Construct <code>Volume</code> based on unordered assets.</div></div><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.into_smoothing.html" title="pallet_ema_oracle::into_smoothing fn">into_smoothing</a></div><div class="item-right docblock-short">Convert a given <code>period</code> into the smoothing factor used in the weighted average.
See [<code>check_period_smoothing_factors</code>] for how the values are generated.</div></div><div class="item-row"><div class="item-left module-item"><a class="fn" href="fn.ordered_pair.html" title="pallet_ema_oracle::ordered_pair fn">ordered_pair</a></div><div class="item-right docblock-short">Return ordered asset tuple (A,B) where A &lt; B
Used in storage
The implementation is the same as for AssetPair</div></div></div><h2 id="types" class="small-section-header"><a href="#types">Type Definitions</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="type" href="type.AssetId.html" title="pallet_ema_oracle::AssetId type">AssetId</a></div></div><div class="item-row"><div class="item-left module-item"><a class="type" href="type.Balance.html" title="pallet_ema_oracle::Balance type">Balance</a></div></div><div class="item-row"><div class="item-left module-item"><a class="type" href="type.Price.html" title="pallet_ema_oracle::Price type">Price</a></div><div class="item-right docblock-short">A price is a tuple of two <code>u128</code>s representing the numerator and denominator of a rational number.</div></div><div class="item-row"><div class="item-left module-item"><a class="type" href="type.Source.html" title="pallet_ema_oracle::Source type">Source</a></div><div class="item-right docblock-short">Identifier for oracle data sources.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="pallet_ema_oracle" data-themes="" data-resource-suffix="" data-rustdoc-version="1.67.0-nightly (234151769 2022-12-03)" data-search-js="search-444266647c4dba98.js" data-settings-js="settings-bebeae96e00e4617.js" data-settings-css="settings-af96d9e2fc13e081.css" ></div></body></html>