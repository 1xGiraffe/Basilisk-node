<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Non const static initialization, and program constructor/destructor code."><meta name="keywords" content="rust, rustlang, rust-lang, static_init"><title>static_init - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-1f7d512b176f0f72.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-124a1ca42af929b6.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-e963ab4a0d0c903e.css" id="mainThemeStyle"><link rel="stylesheet" id="themeStyle" href="../static.files/light-046227e470cd3629.css"><link rel="stylesheet" disabled href="../static.files/dark-800f2ee593c8e6f7.css"><link rel="stylesheet" disabled href="../static.files/ayu-9edae3c387f5a5b3.css"><script id="default-settings" ></script><script src="../static.files/storage-d43fa987303ecbbb.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-287cecec4dbb45b0.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../static_init/index.html"><div class="logo-container"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><h2></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../static_init/index.html"><div class="logo-container"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><h2 class="location"><a href="#">Crate static_init</a></h2><div class="sidebar-elems"><ul class="block"><li class="version">Version 0.5.2</li><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#attributes">Attribute Macros</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-5ec35bf9ca753509.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn">Crate <a class="mod" href="#">static_init</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../src/static_init/lib.rs.html#8-608">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Non const static initialization, and program constructor/destructor code.</p>
<h2 id="lesser-lazy-statics"><a href="#lesser-lazy-statics">Lesser Lazy Statics</a></h2>
<p>This crate provides <em>lazy statics</em> on all plateforms.</p>
<p>On unixes and windows <em>lesser lazy statics</em> are <em>lazy</em> during program startup phase
(before <code>main</code> is called). Once main is called, those statics are all guaranteed to be
initialized and any access to them is as fast as any access to regular const initialized
statics. Benches sho that usual lazy statics, as those provided by <code>std::lazy::*</code> or from
<a href="https://crates.io/crates/lazy_static">lazy_static</a> crate, suffer from a 2ns access penalty.</p>
<p><em>Lesser lazy statics</em> can optionaly be dropped at program destruction
(after main exit but before the program stops).</p>
<p><em>Lesser lazy statics</em> require the standard library and are enabled by default
crate features <code>lazy</code> and <code>atexit</code>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>static_init::{dynamic};

<span class="attr">#[dynamic] </span><span class="comment">//equivalent to #[dynamic(lazy)]
</span><span class="kw">static </span>L1: Vec&lt;i32&gt; = <span class="kw">unsafe</span>{L0.clone()};

<span class="attr">#[dynamic(drop)] </span><span class="comment">//equivalent to #[dynamic(lazy,drop)]
</span><span class="kw">static </span>L0: Vec&lt;i32&gt; = <span class="macro">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];

<span class="attr">#[dynamic(drop)]
</span><span class="kw">static </span><span class="kw-2">mut </span>L2: Vec&lt;i32&gt; = L1.clone();</code></pre></div>
<p>As can be seen above accesses to <em>lazy static</em> that are dropped must be within unsafe
blocks. The reason is that it is possible at program destruction to access already dropped
lazy statics.</p>
<h2 id="dynamic-statics-statics-initialized-at-program-startup"><a href="#dynamic-statics-statics-initialized-at-program-startup">Dynamic statics: statics initialized at program startup</a></h2>
<p>On plateforms that support it (unixes, mac, windows), this crate provides <em>dynamic statics</em>: statics that are
initialized at program startup. This feature is <code>no_std</code>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>static_init::{dynamic};

<span class="attr">#[dynamic(<span class="number">0</span>)]
</span><span class="comment">//equivalent to #[dynamic(init=0)]
</span><span class="kw">static </span>D1: Vec&lt;i32&gt; = <span class="macro">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];
 
<span class="macro">assert_eq!</span>(<span class="kw">unsafe</span>{D1[<span class="number">0</span>]}, <span class="number">1</span>);</code></pre></div>
<p>As can be seen above, even if D1 is not mutable, access to it must be performed in unsafe
blocks. The reason is that during startup phase, accesses to <em>dynamic statics</em> may cause
<em>undefined behavior</em>: <em>dynamic statics</em> may be in a zero initialized state.</p>
<p>To prevent such hazardeous accesses, on unixes and window plateforms, a priority can be
specified. Dynamic static initializations with higher priority are sequenced before dynamic
static initializations with lower priority. Dynamic static initializations with the same
priority are underterminately sequenced.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>static_init::{dynamic};

<span class="comment">// D2 initialization is sequenced before D1 initialization
</span><span class="attr">#[dynamic(<span class="number">0</span>)]
</span><span class="kw">static </span><span class="kw-2">mut </span>D1: Vec&lt;i32&gt; = <span class="kw">unsafe</span>{D2.clone()};

<span class="attr">#[dynamic(<span class="number">10</span>)]
</span><span class="kw">static </span>D2: Vec&lt;i32&gt; = <span class="macro">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</code></pre></div>
<p><em>Dynamic statics</em> can be dropped at program destruction phase: they are dropped after main
exit:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>static_init::{dynamic};

<span class="comment">// D2 initialization is sequenced before D1 initialization
// D1 drop is sequenced before D2 drop.
</span><span class="attr">#[dynamic(init=<span class="number">0</span>,drop=<span class="number">0</span>)]
</span><span class="kw">static </span><span class="kw-2">mut </span>D1: Vec&lt;i32&gt; = <span class="kw">unsafe </span>{D2.clone()};

<span class="attr">#[dynamic(init=<span class="number">10</span>,drop=<span class="number">10</span>)]
</span><span class="kw">static </span>D2: Vec&lt;i32&gt; = <span class="macro">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</code></pre></div>
<p>The priority act on drop in reverse order. <em>Dynamic statics</em> drops with a lower priority are
sequenced before <em>dynamic statics</em> drops with higher priority.</p>
<p>Finally, if the feature <code>atexit</code> is enabled, <em>dynamic statics</em> drop can be registered with
<code>libc::atexit</code>. <em>lazy dynamic statics</em> and <em>dynamic statics</em> with <code>drop_reverse</code> attribute
argument are destroyed in the reverse order of their construction. Functions registered with
<code>atexit</code> are executed before program destructors and drop of <em>dynamic statics</em> that use the
<code>drop</code> attribute argument. Drop is registered with at <code>atexit</code> if no priority if given to the
<code>drop</code> attribute argument.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>static_init::{dynamic};

<span class="comment">//D1 is dropped before D2 because
//it is initialized before D2
</span><span class="attr">#[dynamic(lazy,drop)]
</span><span class="kw">static </span>D1: Vec&lt;i32&gt; = <span class="macro">vec!</span>[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>];

<span class="attr">#[dynamic(<span class="number">10</span>,drop)]
</span><span class="kw">static </span>D2: Vec&lt;i32&gt; = <span class="kw">unsafe</span>{D1.clone()};

<span class="comment">//D3 is initilized after D1 and D2 initializations
//and it is dropped after D1 and D2 drops
</span><span class="attr">#[dynamic(<span class="number">5</span>,drop)]
</span><span class="kw">static </span>D3: Vec&lt;i32&gt; = <span class="kw">unsafe</span>{D1.clone()};</code></pre></div>
<h2 id="constructor-and-destructor"><a href="#constructor-and-destructor">Constructor and Destructor</a></h2>
<p>On plateforms that support it (unixes, mac, windows), this crate provides a way to declare
<em>constructors</em>: a function called before main is called. This feature is <code>no_std</code>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>static_init::{constructor};

<span class="comment">//called before main
</span><span class="attr">#[constructor] </span><span class="comment">//equivalent to #[constructor(0)]
</span><span class="kw">extern </span><span class="string">&quot;C&quot; </span><span class="kw">fn </span>some_init() {}</code></pre></div>
<p>Constructors also support priorities. Sequencement rules applies also between constructor calls and
between <em>dynamic statics</em> initialization and <em>constructor</em> calls.</p>
<p><em>destructors</em> are called at program destruction. They also support priorities.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>static_init::{constructor, destructor};

<span class="comment">//called before some_init
</span><span class="attr">#[constructor(<span class="number">10</span>)]
</span><span class="kw">extern </span><span class="string">&quot;C&quot; </span><span class="kw">fn </span>pre_init() {}

<span class="comment">//called before main
</span><span class="attr">#[constructor]
</span><span class="kw">extern </span><span class="string">&quot;C&quot; </span><span class="kw">fn </span>some_init() {}

<span class="comment">//called after main
</span><span class="attr">#[destructor]
</span><span class="kw">extern </span><span class="string">&quot;C&quot; </span><span class="kw">fn </span>first_destructor() {}

<span class="comment">//called after first_destructor
</span><span class="attr">#[destructor(<span class="number">10</span>)]
</span><span class="kw">extern </span><span class="string">&quot;C&quot; </span><span class="kw">fn </span>last_destructor() {}</code></pre></div>
<h2 id="thread-local-support"><a href="#thread-local-support">Thread Local Support</a></h2>
<p>Variable declared with <code>#[dynamic(lazy)]</code> can also be declared <code>#[thread_local]</code>. These
variable will behave as regular <em>lazy statics</em>.</p>

<div class="example-wrap ignore"><div class='tooltip'>ⓘ</div><pre class="rust rust-example-rendered"><code><span class="attr">#[thread_local]
#[dynamic(lazy)]
</span><span class="kw">static </span><span class="kw-2">mut </span>X: Vec&lt;i32&gt; = <span class="macro">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</code></pre></div>
<p>These variables can also be droped on thread exit.</p>

<div class="example-wrap ignore"><div class='tooltip'>ⓘ</div><pre class="rust rust-example-rendered"><code><span class="attr">#[thread_local]
#[dynamic(lazy,drop)]
</span><span class="kw">static </span>X: Vec&lt;i32&gt; = <span class="macro">vec!</span>[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];

<span class="macro">assert!</span>(<span class="kw">unsafe</span>{X[<span class="number">1</span>] == <span class="number">2</span>});</code></pre></div>
<p>Accessing a thread local <em>lazy statics</em> that should drop during the phase where thread_locals are
droped may cause <em>undefined behavior</em>. For this reason any access to a thread local lazy static
that is dropped will require an unsafe block, even if the static is const.</p>
<h2 id="debuging-initialization-order"><a href="#debuging-initialization-order">Debuging initialization order</a></h2>
<p>If the feature <code>debug_order</code> is enabled, attempts to access <code>dynamic statics</code> that are
uninitialized or whose initialization is undeterminately sequenced with the access will cause
a panic with a message specifying which statics was tentatively accessed and how to change this
<em>dynamic static</em> priority to fix this issue.</p>
<p>Run <code>cargo test</code> in this crate directory to see message examples.</p>
<p>All implementations of lazy statics may suffer from circular initialization dependencies. Those
circular dependencies will cause either a dead lock or an infinite loop. If the feature <code>debug_order</code> is
enabled, atemp are made to detect those circular dependencies. In most case they will be detected.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ConstLazy.html" title="static_init::ConstLazy struct">ConstLazy</a></div><div class="item-right docblock-short">The type of const <em>lesser lazy statics</em>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ConstStatic.html" title="static_init::ConstStatic struct">ConstStatic</a></div><div class="item-right docblock-short">The actual type of non mutable <em>dynamic statics</em>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Lazy.html" title="static_init::Lazy struct">Lazy</a></div><div class="item-right docblock-short">The type of <em>lesser lazy statics</em>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Static.html" title="static_init::Static struct">Static</a></div><div class="item-right docblock-short">The actual type of mutable <em>dynamic statics</em>.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ThreadLocalConstLazy.html" title="static_init::ThreadLocalConstLazy struct">ThreadLocalConstLazy</a></div><div class="item-right docblock-short">The type of const thread local lazy that will be dropped.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ThreadLocalLazy.html" title="static_init::ThreadLocalLazy struct">ThreadLocalLazy</a></div><div class="item-right docblock-short">The type of thread local lazy.</div></div></div><h2 id="attributes" class="small-section-header"><a href="#attributes">Attribute Macros</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="attr" href="attr.constructor.html" title="static_init::constructor attr">constructor</a></div><div class="item-right docblock-short">Attribute for functions run at program initialization (before main).</div></div><div class="item-row"><div class="item-left module-item"><a class="attr" href="attr.destructor.html" title="static_init::destructor attr">destructor</a></div><div class="item-right docblock-short">Attribute for functions run at program termination (after main)</div></div><div class="item-row"><div class="item-left module-item"><a class="attr" href="attr.dynamic.html" title="static_init::dynamic attr">dynamic</a></div><div class="item-right docblock-short">Statics initialized with non const functions.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="static_init" data-themes="" data-resource-suffix="" data-rustdoc-version="1.67.0-nightly (234151769 2022-12-03)" data-search-js="search-444266647c4dba98.js" data-settings-js="settings-bebeae96e00e4617.js" data-settings-css="settings-af96d9e2fc13e081.css" ></div></body></html>